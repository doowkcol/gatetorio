==========================================
Gatetorio BLE Server
==========================================
Starting at: Sun 16 Nov 01:11:25 GMT 2025

==========================================
Gatetorio BLE Server Startup
==========================================

Step 1: Checking for existing gate controller instances...
[0;32mâœ“ No existing controller instances found[0m

Step 2: Cleaning Bluetooth state...
  Restarting Bluetooth service...
[0;32mâœ“ Bluetooth service is running[0m

Step 3: Checking Bluetooth adapter...
[0;32mâœ“ Bluetooth adapter UP: hci0:	Type: Primary  Bus: UART[0m

Step 4: Starting BLE server...
==========================================

[Main] Initializing Gatetorio gate controller...
[Main] WARNING: Make sure no other controller instance is running!
[Main] Close the desktop launcher before starting BLE server.

[Main] Step 1: Waiting for hardware initialization...
[Main] Step 2: Creating controller instance...
Gate Controller V2 (Step 3 - Three Processes) initialized
  M1 travel time: 7.835115489037847s, M2 travel time: 8.557032567378949s
  M2 enabled: True
  Motor Manager PID: 9115
  Input Manager PID: 9116
  Auto-close: ENABLED (5.0s)
Motor Manager initialized
Motor Manager process started
Input Manager: ADC1 initialized at address 0x48 (ADDR->GND)
Input Manager: ADC2 initialized at address 0x49 (ADDR->VDD)
Input Manager: 2 ADC(s) initialized successfully (8 channels available)
Input Manager initialized:
  Inputs configured: 8
  Sample rate: 0.1s (10.0Hz)
  ADC available: True
  Channels available: 8
Input Manager: Starting main loop

================================================================================
CONFIGURED INPUTS (8 total):
================================================================================
  IN1                  Ch= 0 Type=NC  Func=close_limit_m1       [ENABLED]
  IN2                  Ch= 1 Type=NO  Func=open_limit_m1        [ENABLED]
  IN3                  Ch= 2 Type=NO  Func=open_limit_m2        [ENABLED]
  IN4                  Ch= 3 Type=NC  Func=close_limit_m2       [ENABLED]
  IN5                  Ch= 4 Type=NO  Func=cmd_open             [ENABLED]
  IN6                  Ch= 5 Type=8K2 Func=safety_stop_opening  [ENABLED]
  IN7                  Ch= 6 Type=NO  Func=None                 [ENABLED]
  IN8                  Ch= 7 Type=NO  Func=None                 [ENABLED]
================================================================================

[INPUT RAW] IN1                  func=close_limit_m1       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN1                  func=close_limit_m1       â†’ ACTIVE
[INPUT RAW] IN4                  func=close_limit_m2       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN4                  func=close_limit_m2       â†’ ACTIVE
[STARTUP] Detected gate at CLOSED position (both motors at close limits)
[Main] Step 3: Waiting for input manager to stabilize (5 seconds)...
[Main]   This allows ADC readings to settle before safety checks
[Main] Step 4: Verifying input readings...
[Main]   âœ“ Inputs stable - safety system nominal
[Main] âœ“ Controller initialized and stable

[Main] Initializing BLE server...
[BLE] Initialized - Hardware ID: 98697DF6
[BLE] User ID: gatetorio-default
[Main] Starting BLE GATT server...
============================================================
Gatetorio BLE Server v1.0.0 (bluezero)
============================================================
Hardware ID: 98697DF6
User ID: gatetorio-default
Stealth mode: True
Whitelist enabled: True
[BLE] TESTING MODE: Pairing window ALWAYS OPEN (device always visible)
[BLE] Device will be discoverable as: Gatetorio-7DF6
[BLE] Building GATT server...
[BLE] Using Bluetooth adapter: 2C:CF:67:A4:C4:D0
[BLE] Adding Device Info service...
[BLE] Adding Gate Control service...
[BLE] Adding Configuration service...
[BLE] Adding Diagnostics service...
[BLE] Adding Security service...
[BLE] GATT server built successfully
[BLE] Starting GATT server...
[BLE] Attempting to register advertisement with single UUID...
[BLE] âš  peripheral.advertise() method not available: 'Peripheral' object has no attribute 'advertise'
[BLE] This bluezero version doesn't support peripheral.advertise()
[BLE] Need to refactor to use localGATT + Advertisement API (Option A)

[BLE] IMPLEMENTATION REQUIRED:
[BLE] The code needs to be refactored to use:
[BLE]   - localGATT.Application() for GATT server
[BLE]   - advertisement.Advertisement() for manual advertisement
[BLE]   - Only advertise Gate Control UUID
[BLE]   - Keep all 3 services as PRIMARY (discoverable after connection)

[BLE] Error: peripheral.advertise() not available - need localGATT refactor
Traceback (most recent call last):
  File "/home/doowkcol/Gatetorio_Code/ble_server_bluezero.py", line 849, in start
    ble_peripheral.advertise(
    ^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'Peripheral' object has no attribute 'advertise'. Did you mean: 'advert'?

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/doowkcol/Gatetorio_Code/ble_server_bluezero.py", line 873, in start
    raise RuntimeError("peripheral.advertise() not available - need localGATT refactor")
RuntimeError: peripheral.advertise() not available - need localGATT refactor
Exception in thread Thread-2 (_control_loop):
Process Process-2:

==========================================
BLE server stopped
==========================================
