==========================================
Gatetorio BLE Server
==========================================
Starting at: Sun 16 Nov 00:26:39 GMT 2025

==========================================
Gatetorio BLE Server Startup
==========================================

Step 1: Checking for existing gate controller instances...
[0;32mâœ“ No existing controller instances found[0m

Step 2: Cleaning Bluetooth state...
  Restarting Bluetooth service...
[0;32mâœ“ Bluetooth service is running[0m

Step 3: Checking Bluetooth adapter...
[0;32mâœ“ Bluetooth adapter UP: hci0:	Type: Primary  Bus: UART[0m

Step 4: Starting BLE server...
==========================================

[Main] Initializing Gatetorio gate controller...
[Main] WARNING: Make sure no other controller instance is running!
[Main] Close the desktop launcher before starting BLE server.

[Main] Step 1: Waiting for hardware initialization...
[Main] Step 2: Creating controller instance...
Gate Controller V2 (Step 3 - Three Processes) initialized
  M1 travel time: 7.835115489037847s, M2 travel time: 8.557032567378949s
  M2 enabled: True
  Motor Manager PID: 3157
  Input Manager PID: 3158
  Auto-close: ENABLED (5.0s)
Motor Manager initialized
Motor Manager process started
Input Manager: ADC1 initialized at address 0x48 (ADDR->GND)
Input Manager: ADC2 initialized at address 0x49 (ADDR->VDD)
Input Manager: 2 ADC(s) initialized successfully (8 channels available)
Input Manager initialized:
  Inputs configured: 8
  Sample rate: 0.1s (10.0Hz)
  ADC available: True
  Channels available: 8
Input Manager: Starting main loop

================================================================================
CONFIGURED INPUTS (8 total):
================================================================================
  IN1                  Ch= 0 Type=NC  Func=close_limit_m1       [ENABLED]
  IN2                  Ch= 1 Type=NO  Func=open_limit_m1        [ENABLED]
  IN3                  Ch= 2 Type=NO  Func=open_limit_m2        [ENABLED]
  IN4                  Ch= 3 Type=NC  Func=close_limit_m2       [ENABLED]
  IN5                  Ch= 4 Type=NO  Func=cmd_open             [ENABLED]
  IN6                  Ch= 5 Type=8K2 Func=safety_stop_opening  [ENABLED]
  IN7                  Ch= 6 Type=NO  Func=None                 [ENABLED]
  IN8                  Ch= 7 Type=NO  Func=None                 [ENABLED]
================================================================================

[INPUT RAW] IN1                  func=close_limit_m1       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN1                  func=close_limit_m1       â†’ ACTIVE
[INPUT RAW] IN4                  func=close_limit_m2       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN4                  func=close_limit_m2       â†’ ACTIVE
[STARTUP] Detected gate at CLOSED position (both motors at close limits)
[Main] Step 3: Waiting for input manager to stabilize (5 seconds)...
[Main]   This allows ADC readings to settle before safety checks
[Main] Step 4: Verifying input readings...
[Main]   âœ“ Inputs stable - safety system nominal
[Main] âœ“ Controller initialized and stable

[Main] Initializing BLE server...
[BLE] Initialized - Hardware ID: 98697DF6
[BLE] User ID: gatetorio-default
[Main] Starting BLE GATT server...
============================================================
Gatetorio BLE Server v1.0.0 (bluezero)
============================================================
Hardware ID: 98697DF6
User ID: gatetorio-default
Stealth mode: True
Whitelist enabled: True
[BLE] TESTING MODE: Pairing window ALWAYS OPEN (device always visible)
[BLE] Device will be discoverable as: Gatetorio-7DF6
[BLE] Building GATT server...
[BLE] Using Bluetooth adapter: 2C:CF:67:A4:C4:D0
[BLE] Adding Device Info service...
[BLE] Adding Gate Control service...
[BLE] Adding Configuration service...
[BLE] Adding Diagnostics service...
[BLE] Adding Security service...
[BLE] GATT server built successfully
[BLE] Starting GATT server...
[BLE] Registering BLE advertisement...
Advertisement registered
[BLE] Status notifications enabled - starting 1Hz update timer
[INPUT RAW] IN5                  func=cmd_open             raw=ACTIVE was=inactive V=3.31
[INPUT DEBOUNCED] IN5                  func=cmd_open             â†’ ACTIVE
[INPUT] cmd_open             â†’ ACTIVE

>>> [_execute_open CALLED] M1:0.0s M2:0.0s
    Current state: CLOSED, safety_reversing: False
    Flags: cmd_open=True, stop_opening_active=False
[INPUT RAW] IN5                  func=cmd_open             raw=inactive was=ACTIVE V=0.00
[INPUT RAW] IN5                  func=cmd_open             raw=inactive was=ACTIVE V=0.00
[INPUT DEBOUNCED] IN5                  func=cmd_open             â†’ inactive
[INPUT] cmd_open             â†’ inactive
[INPUT RAW] IN1                  func=close_limit_m1       raw=inactive was=ACTIVE V=3.31
[INPUT RAW] IN1                  func=close_limit_m1       raw=inactive was=ACTIVE V=3.31
[INPUT DEBOUNCED] IN1                  func=close_limit_m1       â†’ inactive
[INPUT RAW] IN4                  func=close_limit_m2       raw=inactive was=ACTIVE V=3.31
[INPUT RAW] IN4                  func=close_limit_m2       raw=inactive was=ACTIVE V=3.31
[INPUT DEBOUNCED] IN4                  func=close_limit_m2       â†’ inactive
[FAULT] M1 LIMIT_MISSING: OPENING - open limit not activated at 7.84s (consecutive MOVEMENTS: 1)
[INPUT RAW] IN2                  func=open_limit_m1        raw=ACTIVE was=inactive V=3.31
[INPUT DEBOUNCED] IN2                  func=open_limit_m1        â†’ ACTIVE
[LIMIT SWITCH] M1 OPEN limit reached - position was 7.94s (101.3%), setting to 7.84s (100%)
[FAULT] M1 fault counter cleared (was 1)
[FAULT] M2 LIMIT_MISSING: OPENING - open limit not activated at 8.56s (consecutive MOVEMENTS: 1)
[INPUT RAW] IN3                  func=open_limit_m2        raw=ACTIVE was=inactive V=3.31
[INPUT DEBOUNCED] IN3                  func=open_limit_m2        â†’ ACTIVE
[COMPLETION] OPEN complete! M1: limit=True, M2: limit=True
[_complete_open] BEFORE: state=OPENING, M1=7.84, M2=8.72
[_complete_open] AFTER: state=OPEN, movement_command=None
Gates OPEN
Auto-close triggered (from full OPEN) - sending momentary CLOSE pulse
Auto-close pulse - no PO sustained, closing fully

>>> CLOSE command - M1:7.8s M2:8.6s
[INPUT RAW] IN3                  func=open_limit_m2        raw=inactive was=ACTIVE V=0.00
[INPUT RAW] IN3                  func=open_limit_m2        raw=inactive was=ACTIVE V=0.00
[INPUT DEBOUNCED] IN3                  func=open_limit_m2        â†’ inactive
[INPUT RAW] IN2                  func=open_limit_m1        raw=inactive was=ACTIVE V=0.00
[INPUT RAW] IN2                  func=open_limit_m1        raw=inactive was=ACTIVE V=0.00
[INPUT DEBOUNCED] IN2                  func=open_limit_m1        â†’ inactive
[FAULT] M2 LIMIT_MISSING: CLOSING - close limit not activated at position 0 (consecutive MOVEMENTS: 2)
[INPUT RAW] IN4                  func=close_limit_m2       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN4                  func=close_limit_m2       â†’ ACTIVE
[LIMIT SWITCH] M2 CLOSE limit reached - position was 0.07s (0.8%), setting to 0.0s (0%)
[FAULT] M2 fault counter cleared (was 2)
[INPUT RAW] IN1                  func=close_limit_m1       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN1                  func=close_limit_m1       â†’ ACTIVE
[COMPLETION] CLOSE complete! M1: limit=True, M2: limit=True
[_complete_close] BEFORE: state=CLOSING, M1=0.11, M2=-0.00
[_complete_close] AFTER: state=CLOSED, movement_command=None
Gates CLOSED
[BLE] ========================================
[BLE] Received write to Command TX
[BLE] Raw bytes (55): b'{"cmd":"pulse","key":"cmd_open","timestamp":1763253106}'
[BLE] Decoded: {"cmd":"pulse","key":"cmd_open","timestamp":1763253106}
[BLE] Command: pulse cmd_open

>>> [_execute_open CALLED] M1:0.0s M2:0.0s
    Current state: CLOSED, safety_reversing: False
    Flags: cmd_open=True, stop_opening_active=False
[BLE] Response: {'success': True, 'message': 'Pulse sent: cmd_open'}
[BLE] ========================================
[INPUT RAW] IN1                  func=close_limit_m1       raw=inactive was=ACTIVE V=3.31
[INPUT RAW] IN1                  func=close_limit_m1       raw=inactive was=ACTIVE V=3.31
[INPUT DEBOUNCED] IN1                  func=close_limit_m1       â†’ inactive
[INPUT RAW] IN4                  func=close_limit_m2       raw=inactive was=ACTIVE V=3.31
[INPUT RAW] IN4                  func=close_limit_m2       raw=inactive was=ACTIVE V=3.31
[INPUT DEBOUNCED] IN4                  func=close_limit_m2       â†’ inactive
[FAULT] M1 LIMIT_MISSING: OPENING - open limit not activated at 7.84s (consecutive MOVEMENTS: 1)
[INPUT RAW] IN2                  func=open_limit_m1        raw=ACTIVE was=inactive V=3.31
[INPUT DEBOUNCED] IN2                  func=open_limit_m1        â†’ ACTIVE
[FAULT] M1 fault counter cleared (was 1)
[LIMIT SWITCH] M1 OPEN limit reached - position was 7.93s (101.3%), setting to 7.84s (100%)
[FAULT] M2 LIMIT_MISSING: OPENING - open limit not activated at 8.56s (consecutive MOVEMENTS: 1)
[INPUT RAW] IN3                  func=open_limit_m2        raw=ACTIVE was=inactive V=3.31
[INPUT DEBOUNCED] IN3                  func=open_limit_m2        â†’ ACTIVE
[LIMIT SWITCH] M2 OPEN limit reached - position was 8.65s (101.1%), setting to 8.56s (100%)[COMPLETION] OPEN complete! M1: limit=True, M2: limit=True

[_complete_open] BEFORE: state=OPENING, M1=7.84, M2=8.65
[_complete_open] AFTER: state=OPEN, movement_command=None
Gates OPEN
Auto-close triggered (from full OPEN) - sending momentary CLOSE pulse
Auto-close pulse - no PO sustained, closing fully

>>> CLOSE command - M1:7.8s M2:8.6s
[INPUT RAW] IN3                  func=open_limit_m2        raw=inactive was=ACTIVE V=0.00
[INPUT RAW] IN3                  func=open_limit_m2        raw=inactive was=ACTIVE V=0.00
[INPUT DEBOUNCED] IN3                  func=open_limit_m2        â†’ inactive
[INPUT RAW] IN2                  func=open_limit_m1        raw=inactive was=ACTIVE V=0.00
[INPUT RAW] IN2                  func=open_limit_m1        raw=inactive was=ACTIVE V=0.00
[INPUT DEBOUNCED] IN2                  func=open_limit_m1        â†’ inactive
[INPUT RAW] IN4                  func=close_limit_m2       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN4                  func=close_limit_m2       â†’ ACTIVE
[LIMIT SWITCH] M2 CLOSE limit reached - position was 0.11s (1.3%), setting to 0.0s (0%)
[FAULT] M2 fault counter cleared (was 1)
[FAULT] M1 LIMIT_MISSING: CLOSING - close limit not activated at position 0 (consecutive MOVEMENTS: 1)
[INPUT RAW] IN1                  func=close_limit_m1       raw=ACTIVE was=inactive V=0.00
[INPUT DEBOUNCED] IN1                  func=close_limit_m1       â†’ ACTIVE
[LIMIT SWITCH] M1 CLOSE limit reached - position was 0.09s (1.2%), setting to 0.0s (0%)
[COMPLETION] CLOSE complete! M1: limit=True, M2: limit=True
[_complete_close] BEFORE: state=CLOSING, M1=0.00, M2=-0.00
[_complete_close] AFTER: state=CLOSED, movement_command=None
Gates CLOSED
